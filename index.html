<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Crédits</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    



    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); margin-bottom: 1rem; }
        .payment-status-paid { color: #28a745; font-weight: bold; }
        .payment-status-pending { color: #ffc107; font-weight: bold; }
        .progress { height: 10px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <span class="navbar-brand">Gestionnaire de Crédits SQLite</span>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <span id="userEmail">Non connecté</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="logout()">Déconnexion</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="modal fade" id="authModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Connexion</h5>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" value="admin@creditapp.com" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mot de passe</label>
                            <input type="password" class="form-control" id="password" value="admin123" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Se connecter</button>
                    </form>
                    <div class="text-center mt-3">
                        <small class="text-muted">Utilisez admin@creditapp.com / admin123</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="container" style="display: none;">
        <!-- VOTRE CODE HTML EXISTANT ICI -->
        <!-- Copiez tout le contenu de votre balise <div id="mainApp"> ici -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Gestionnaire d'authentification simplifié
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.init();
            }

            init() {
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.login();
                });
                this.showAuthModal();
            }

            async login() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.currentUser = data.user;
                        localStorage.setItem('currentUser', JSON.stringify(data.user));
                        this.showMainApp();
                        this.hideAuthModal();
                        creditManager.loadCredits();
                    } else {
                        alert(data.error || 'Erreur de connexion');
                    }
                } catch (error) {
                    alert('Erreur de connexion au serveur');
                }
            }

            logout() {
                this.currentUser = null;
                localStorage.removeItem('currentUser');
                this.showAuthModal();
                this.hideMainApp();
            }

            showAuthModal() {
                new bootstrap.Modal(document.getElementById('authModal')).show();
            }

            hideAuthModal() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
                if (modal) modal.hide();
            }

            showMainApp() {
                document.getElementById('mainApp').style.display = 'block';
                document.querySelector('.navbar').style.display = 'flex';
                document.getElementById('userEmail').textContent = this.currentUser.email;
            }

            hideMainApp() {
                document.getElementById('mainApp').style.display = 'none';
                document.querySelector('.navbar').style.display = 'none';
            }

            isAuthenticated() {
                return this.currentUser !== null;
            }
        }

        // Gestionnaire de crédits adapté pour SQLite
        class CreditManager {
            constructor() {
                this.credits = [];
                this.init();
            }

            init() {
                document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('creditForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addCredit();
                });
            }

            async loadCredits() {
                if (!authManager.isAuthenticated()) return;

                try {
                    const response = await fetch(`/api/credits/${authManager.currentUser.id}`);
                    this.credits = await response.json();
                    this.displayCredits();
                } catch (error) {
                    console.error('Erreur chargement crédits:', error);
                }
            }

            async addCredit() {
                if (!authManager.isAuthenticated()) {
                    alert('Veuillez vous connecter');
                    return;
                }

                const creditData = {
                    userId: authManager.currentUser.id,
                    clientName: document.getElementById('clientName').value,
                    clientEmail: document.getElementById('clientEmail').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    interestRate: parseFloat(document.getElementById('interestRate').value),
                    duration: parseInt(document.getElementById('duration').value),
                    startDate: document.getElementById('startDate').value
                };

                try {
                    const response = await fetch('/api/credits', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(creditData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Crédit ajouté avec succès!');
                        document.getElementById('creditForm').reset();
                        document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
                        this.loadCredits();
                    } else {
                        alert(result.error);
                    }
                } catch (error) {
                    alert('Erreur lors de l\'ajout du crédit');
                }
            }

            displayCredits() {
                const tbody = document.getElementById('creditsTable');
                tbody.innerHTML = '';

                this.credits.forEach(credit => {
                    const progress = (credit.paid_months / credit.duration) * 100;
                    const status = this.getCreditStatus(credit);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <strong>${credit.client_name}</strong>
                            ${credit.client_email ? `<br><small class="text-muted">${credit.client_email}</small>` : ''}
                        </td>
                        <td>${credit.amount.toFixed(2)} €</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar" style="width: ${progress}%">
                                    ${credit.paid_months}/${credit.duration}
                                </div>
                            </div>
                            <small class="text-muted">${credit.paid_amount.toFixed(2)}€ payés</small>
                        </td>
                        <td>${credit.interest_rate}%</td>
                        <td>${credit.duration} mois</td>
                        <td>${credit.monthly_payment.toFixed(2)} €</td>
                        <td>
                            <span class="payment-status-${status}">${status}</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success" onclick="creditManager.showPaymentModal(${credit.id})">
                                    <i class="fas fa-money-bill-wave"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="creditManager.deleteCredit(${credit.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            getCreditStatus(credit) {
                if (credit.paid_months === 0) return 'En attente';
                if (credit.paid_months >= credit.duration) return 'Payé';
                return 'En cours';
            }

            async deleteCredit(creditId) {
                if (!confirm('Supprimer ce crédit ?')) return;

                try {
                    const response = await fetch(`/api/credits/${creditId}`, { method: 'DELETE' });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.loadCredits();
                    } else {
                        alert(result.error);
                    }
                } catch (error) {
                    alert('Erreur suppression');
                }
            }

            showPaymentModal(creditId) {
                // Implémentez cette fonction selon vos besoins
                alert('Fonctionnalité paiement - À implémenter');
            }
        }

        // Initialisation
        const authManager = new AuthManager();
        const creditManager = new CreditManager();

        // Fonctions globales
        window.logout = () => authManager.logout();
        window.calculateInterest = () => {
            const amount = parseFloat(document.getElementById('calcAmount').value) || 0;
            const rate = parseFloat(document.getElementById('calcRate').value) || 0;
            const months = parseInt(document.getElementById('calcMonths').value) || 0;

            const monthlyRate = rate / 100 / 12;
            const monthlyPayment = amount * (monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
            const totalInterest = (monthlyPayment * months) - amount;

            document.getElementById('resultText').innerHTML = `
                Mensualité: ${monthlyPayment.toFixed(2)} €<br>
                Intérêts totaux: ${totalInterest.toFixed(2)} €
            `;
            document.getElementById('calculationResult').classList.remove('d-none');
        };
    </script>
</body>
</html>